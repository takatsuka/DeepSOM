<!DOCTYPE html>
<html>
<style>
    .som {
        width: 165px;
        margin: 1rem 0 0 1rem;
        background-color: #29e;
        color: white;
        border-radius: 0.75em;
        padding: 20px;
        touch-action: none;
        user-select: none;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 2;
    }

    body {
        font-family: 'Open Sans', sans-serif;
    }

    .svg-box svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        z-index: -1;
    }

    .svg-box {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        width: 100%;
        z-index: -1;
        transform: scale(1);
        transform-origin: 0 0;
        overflow: hidden;
    }

    .drag-drop-box {
        position: relative;
        z-index: 3;
        border: 4px dotted red;
        overflow: hidden;
    }

    .add-som-btn {
        z-index: 4;
        position: relative;
    }

    .som-box {
        position: absolute;
        top: 0;
        z-index: 1;
        width: 100%;
        width: 100%;
        border: 4px dotted white;
        padding: 5px;
        transform: scale(1);
        transform-origin: 0 0;
        overflow: hidden;
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
<script>
    function togglePlay() {
        $("#audio_icon").toggleClass("fa-spin");
        if ($("#audio_icon").hasClass("fa-spin")) {
            $("#abcd-song").trigger("play");
        } else {
            $("#abcd-song").trigger("pause");
        }
    };

    var next_som_id = 1;

    function add_som() {

        var som_id = 'som_' + next_som_id;

        $(".som-box").append(`<div class="som draggable" id="${som_id}" draggable="true">
                                <b>SOM ${next_som_id}</b>
                                <div class="btn-group">
                                    <button onclick="config_som(this)" class="btn btn-sm btn-success"><i class="fa fa-cogs"></i></button>
                                    <button onclick="remove_som(this)" class="btn btn-sm btn-warning"><i class="fa fa-trash"></i></button>
                                </div>
                            </div>`);
        next_som_id++;
        add_link(som_id);
        som_debug();
    }

    function config_som(obj) {
        var config_modal = new bootstrap.Modal(document.getElementById('config_modal'));
        var som_id = $(obj).parent().parent().attr('id');
        $('#config_modal_title').text(`Configure ${som_id}`);
        config_modal.toggle();
    }

    function remove_som(obj) {
        var som_id = $(obj).parent().parent().attr('id');
        $(obj).parent().parent().remove();
        remove_link(som_id);
        som_debug();
    }

    function centre_point(obj) {
        var drag_x = $(".som-box").offset().left
        var drag_y = $(".som-box").offset().top
        var zoom = $("#zoom").text();
        var x = (($(obj).offset().left + $(obj).width() / 2).toFixed(2) - drag_x) / zoom;
        var y = (($(obj).offset().top + $(obj).height() / 2).toFixed(2) - drag_y) / zoom;
        return [x.toFixed(2), y.toFixed(2)];
    }

    function som_debug() {
        $(".debug").append($(".som-box .som").length + " SOMs\n");
        $(".som-box .som").each(function() {
            var [x, y] = centre_point(this);
            var som_id = $(this).attr('id');

            $(".debug").append(`${som_id}: (${x}, ${y})\n`);
        });
        $(".debug").append("--------\n");
        json_output();
    }

    function add_link(new_som_id) {
        $(".debug").text("");
        var new_som_obj = $(`#${new_som_id}`);
        var [x1, y1] = centre_point(new_som_obj);
        $(".som-box .som").each(function() {
            var som_id = $(this).attr('id');
            if (som_id == new_som_id) {
                return;
            }

            var [x2, y2] = centre_point(this);
            $(".debug").append(`linking ${new_som_id} to ${som_id}\n`);

            var link_id = `${new_som_id}_to_${som_id}`;

            $(".svg-box").append(`
            <svg id="${link_id}">
                <line stroke-width="5px" stroke="#ff0000"
                    x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"
                />
            </svg>`);
        });
    }

    function update_link(som_obj) {
        $(".debug").text("");
        var this_som_obj = $(som_obj);
        var update_som_id = this_som_obj.attr('id');
        var [x1, y1] = centre_point(this_som_obj);

        $(".som-box .som").each(function() {
            var som_id = $(this).attr('id');
            if (som_id == update_som_id) {
                return;
            }

            var [x2, y2] = centre_point(this);

            var link_id_a = `${update_som_id}_to_${som_id}`;
            var link_id_b = `${som_id}_to_${update_som_id}`;

            $(`#${link_id_a} line, #${link_id_b} line`).each(function() {
                $(this).attr("x1", x1);
                $(this).attr("x2", x2);
                $(this).attr("y1", y1);
                $(this).attr("y2", y2);
            });

            $(".debug").append(`update links: #${link_id_a} or #${link_id_b}\n`);

        });
    }

    function remove_link(removed_som_id) {
        $(".debug").text("");
        $(".som-box .som").each(function() {
            var som_id = $(this).attr('id');
            if (som_id == removed_som_id) {
                return;
            }

            var link_id_a = `${removed_som_id}_to_${som_id}`;
            var link_id_b = `${som_id}_to_${removed_som_id}`;

            $(`#${link_id_a}, #${link_id_b}`).each(function() {
                $(this).remove();
            });

            $(".debug").append(`removed link: #${link_id_a} or #${link_id_b}\n`);
            update_link($(`#${som_id}`));
        });
    }

    function json_output() {
        var som_data = {
            'nodes': [],
            'links': []
        };
        $(".som-box .som").each(function() {
            som_data['nodes'].push($(this).attr('id'));
        });

        $(".svg-box svg").each(function() {
            som_data['links'].push($(this).attr('id'));
        });

        $('.json').text(JSON.stringify(som_data, null, 4));
    }
</script>

<script>
    $(document).ready(function() {
        // zoom box via scroll
        $(".drag-drop-box").bind('mousewheel', function(e) {
            var x = parseFloat($("#xaxis").text());
            var y = parseFloat($("#yaxis").text());
            var zoom = parseFloat($("#zoom").text());
            if (e.originalEvent.wheelDelta / 100 > 0) {
                zoom += 0.02;
            } else {
                zoom -= 0.02;
            }
            if (zoom > 2) {
                zoom = 2;
            } else if (zoom < 0.3) {
                zoom = 0.3;
            }
            zoom = zoom.toFixed(2);
            $("#zoom").text(zoom);
            $(".svg-box").css('transform', `translate(${x}px, ${y}px) scale(${zoom})`);
            $(".som-box").css('transform', `translate(${x}px, ${y}px) scale(${zoom})`);
            return false;
        });

        // pan / drag drop box

        var _DRAGGGING_STARTED = 0;
        var _LAST_MOUSEMOVE_POSITION = {
            x: null,
            y: null
        };

        $('.drag-drop-box').on('mousedown', function(event) {
            _LAST_MOUSE_POSITION = {
                x: event.pageX,
                y: event.pageY
            };
            _DRAGGGING_STARTED = 1;
        });

        $(document).on('mouseup', function() {
            _DRAGGGING_STARTED = 0;
        });

        $('.drag-drop-box').on('mouseout', function() {
            _DRAGGGING_STARTED = 0;
        });

        $('.drag-drop-box').on('mousemove', function(event) {
            if (_DRAGGGING_STARTED == 1) {
                var x = parseFloat($("#xaxis").text());
                var y = parseFloat($("#yaxis").text());
                var zoom = parseFloat($("#zoom").text());
                var current_mouse_position = {
                    x: event.pageX,
                    y: event.pageY
                };

                var dx = current_mouse_position.x - _LAST_MOUSE_POSITION.x;
                var dy = current_mouse_position.y - _LAST_MOUSE_POSITION.y;

                if (dx > 0) {
                    x += Math.min(dx, 20);
                } else if (dx < 0) {
                    x += Math.max(dx, -20);
                }


                if (dy > 0) {
                    y += Math.min(dy, 20);
                } else if (dy < 0) {
                    y += Math.max(dy, -20);
                }

                /* Save mouse position */
                _LAST_MOUSE_POSITION = current_mouse_position;

                $(".svg-box").css('transform', `translate(${x}px, ${y}px) scale(${zoom})`);
                $(".som-box").css('transform', `translate(${x}px, ${y}px) scale(${zoom})`);
                $("#xaxis").text(x);
                $("#yaxis").text(y);
            }
        });
    });
</script>

<script type="module">
    import interact from 'https://cdn.interactjs.io/v1.10.11/interactjs/index.js'
    // target elements with the "draggable" class
    interact('.draggable')
        .draggable({
            // enable inertial throwing
            inertia: true,
            // keep the element within the area of it's parent
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ],
            // enable autoScroll
            autoScroll: true,

            listeners: {
                // call this function on every dragmove event
                move: dragMoveListener,

                // call this function on every dragend event
                // end(event) {
                //     var textEl = event.target.querySelector('p')
                //
                //     textEl && (textEl.textContent =
                //         'SOM moved a distance of ' +
                //         (Math.sqrt(Math.pow(event.pageX - event.x0, 2) +
                //             Math.pow(event.pageY - event.y0, 2) | 0))
                //         .toFixed(2) + 'px')
                // }
            }
        })

    function dragMoveListener(event) {
        var target = event.target
        // keep the dragged position in the data-x/data-y attributes
        var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx
        var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy

        // translate the element
        target.style.top = y + 'px';
        target.style.left = x + 'px';

        // update the posiion attributes
        target.setAttribute('data-x', x)
        target.setAttribute('data-y', y)

        update_link(event.target);
        som_debug();
    }

    // this function is used later in the resizing and gesture demos
    window.dragMoveListener = dragMoveListener
</script>

<body class="text-white bg-dark">
    <div class="container">

        <h1>Drag & drop concept</h1>

        <audio id="abcd-song" src="abcd-song-lyric.mp3" preload="auto" loop></audio>
        <a onclick="togglePlay()"><i class="fa fa-music" id="audio_icon"></i></a>

        <div class="row">
            <div class="col-8 drag-drop-box">

                <button onclick="add_som()" class="btn btn-info add-som-btn"><i class="fa fa-plus"></i> Add SOM</button>

                <div class="svg-box">
                </div>

                <div class="som-box">
                </div>



            </div>

            <div class="col-4">
                <h2>Zoom</h2>
                <p>Zoom: <span id="zoom">1</span></p>
                <p>X offset: <span id="xaxis">0</span></p>
                <p>Y offset: <span id="yaxis">0</span></p>
                <h2>Debug Data</h2>
                <textarea style="width:100%" rows="20" class="debug"></textarea>
                <h2>JSON Output</h2>
                <textarea style="width:100%" rows="20" class="json"></textarea>
            </div>

        </div>

    </div>

    <!-- Config Modal -->
    <div class="modal fade" id="config_modal" tabindex="-1">
        <div class="modal-dialog bg-transparent">
            <div class="modal-content">
                <div class="modal-header bg-secondary">
                    <h5 class="modal-title" id="config_modal_title">Configure</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary">
                    CONFIGURATION OPTIONS HERE
                </div>
            </div>
        </div>
    </div>

</body>

</html>
