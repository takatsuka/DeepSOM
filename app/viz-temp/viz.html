<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="resources/loadData.js"></script>
    <script type="text/javascript" src="resources/drawViz.js"></script>
    <link rel="stylesheet" href="resources/viz.css">
</head>
<body>
    <input type="file" id="dataInput" />
    <input type="file" id="weightInput" />
    <progress value="0" max="100" id="progress-bar"></progress>
    
    <div id="status"></div>
    <svg id="plot" width="960" height="680"></svg>
    <div class="slidecontainer">
        <input type="range" min="0" max="1" value="0" class="slider" id="progressSlider">
    </div>

    <script>
        var mx, my, mouseX, mouseY;
        var dataCoordinates, weightsCoordinates,currentCoordinates;

        /* -------- d3 object configurations -------- */
        let origin = [480, 300], j = 1, scale = 200, scatter = [], xLine = [], yLine = [], zLine = [], beta = 0, alpha = 0, key = function(d){ return d.id; }, startAngle = Math.PI/4;
        let svg = d3.select('svg').call(d3.drag().on('drag', dragged).on('start', dragStart).on('end', dragEnd)).append('g');
        let color  = d3.scaleOrdinal(d3.schemeCategory20);

        /* -------- d3 object initialisations -------- */
        // Points
        let point3d = d3._3d()
            .x(function(d){ return d.x; })
            .y(function(d){ return d.y; })
            .z(function(d){ return d.z; })
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale); 

        // X axis
        let xScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        // Y axis
        let yScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        // Z axis
        let zScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        /* -------- d3 drag event triggers and calculations -------- */
        // Record mouse coordinate at start of drag
        function dragStart(){
            mx = d3.event.x;
            my = d3.event.y;
        }

        // Record mouse coordinate at end of drag
        function dragEnd(){
            mouseX = d3.event.x - mx + mouseX;
            mouseY = d3.event.y - my + mouseY;
        }

        // Calculate the result rotation from drag and re-draw graph with new configurations
        function dragged(){
            mouseX = mouseX || 0;
            mouseY = mouseY || 0;
            beta   = (d3.event.x - mx + mouseX) * Math.PI / 230 ;
            alpha  = (d3.event.y - my + mouseY) * Math.PI / 230  * (-1);
            let data = [
                point3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)(currentCoordinates[0]),
                xScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)(currentCoordinates[1]),
                yScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)(currentCoordinates[2]),
                zScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)(currentCoordinates[3]),
            ];
            drawPlot(data, 0);
        }

        function updateProgressPlot() {
            let value = document.getElementById('progressSlider').value;
            if (value == 0) {
                currentCoordinates = dataCoordinates;
            } else {
                currentCoordinates = weightsCoordinates;
            }
            updatePlot();
        }
        
        function init() {
            document.getElementById('dataInput').addEventListener('change', (e) => {
                const file = document.getElementById('dataInput').files[0];
                if (file) {
                    // File is valid and start read in process
                    processDataFile(file);
                    // Hide slider
                    document.getElementById("progressSlider").style.display = "none";
                }
            });

            document.getElementById('weightInput').addEventListener('change', (e) => {
                const file = document.getElementById('weightInput').files[0];
                if (file) {
                    processWeightsFile(file);
                }
            });
        }
        
        init();
    </script>
</body>
