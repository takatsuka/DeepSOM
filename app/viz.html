<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <script src="https://unpkg.com/d3-3d/build/d3-3d.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script type="text/javascript" src="resources/loadData.js"></script>
    <script type="text/javascript" src="resources/drawViz.js"></script>
    <link rel="stylesheet" href="resources/viz.css">
</head>
<body>
    <input type="file" id="input" />
    <progress value="0" max="100" id="progress-bar"></progress>
    
    <div id="status"></div>
    <svg width="960" height="680"></svg>
    <div class="slidecontainer">
        <input type="range" min="1" max="100" value="50" class="slider" id="progressSlider">
    </div>

    <script>
        var mx, my, mouseX, mouseY;

        /* -------- d3 object configurations -------- */
        let origin = [480, 300], j = 1, scale = 200, scatter = [], xLine = [], yLine = [], zLine = [], beta = 0, alpha = 0, key = function(d){ return d.id; }, startAngle = Math.PI/4;
        let svg = d3.select('svg').call(d3.drag().on('drag', dragged).on('start', dragStart).on('end', dragEnd)).append('g');
        let color  = d3.scaleOrdinal(d3.schemeCategory20);

        /* -------- d3 object initialisations -------- */
        // Points
        let point3d = d3._3d()
            .x(function(d){ return d.x; })
            .y(function(d){ return d.y; })
            .z(function(d){ return d.z; })
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale); 

        // X axis
        let xScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        // Y axis
        let yScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        // Z axis
        let zScale3d = d3._3d()
            .shape('LINE_STRIP')
            .origin(origin)
            .rotateY( startAngle)
            .rotateX(-startAngle)
            .scale(scale);

        /* -------- d3 drag event triggers and calculations -------- */
        // Record mouse coordinate at start of drag
        function dragStart(){
            mx = d3.event.x;
            my = d3.event.y;
        }

        // Record mouse coordinate at end of drag
        function dragEnd(){
            mouseX = d3.event.x - mx + mouseX;
            mouseY = d3.event.y - my + mouseY;
        }

        // Calculate the result rotation from drag and re-draw graph with new configurations
        function dragged(){
            mouseX = mouseX || 0;
            mouseY = mouseY || 0;
            beta   = (d3.event.x - mx + mouseX) * Math.PI / 230 ;
            alpha  = (d3.event.y - my + mouseY) * Math.PI / 230  * (-1);
            var data = [
                point3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)(scatter),
                xScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)([xLine]),
                yScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)([yLine]),
                zScale3d.rotateY(beta + startAngle).rotateX(alpha - startAngle)([zLine]),
            ];
            processData(data, 0);
        }
        
        function init() {
            document.getElementById('input').addEventListener('change', (e) => {
                const file = document.getElementById('input').files[0];
                if (file) {
                    // File is valid and start read in process
                    processFile(file);
                    // Show slider now that data has been loaded
                    document.getElementById("progressSlider").style.display = "block";
                }
            });
        }
        
        init();
    </script>
</body>
